%D \module
%D   [       file=t-thuthesis,
%D        version=0.1,
%D          title=Tsinghua University \CONTEXT\ Template,
%D       subtitle=Dissertation,
%D         author=Ruini Xue,
%D           date=\currentdate,
%D      copyright=Public Domain]

\writestatus{loading}{Tsinghua University \CONTEXT\ Template}

\unprotect

\startmodule[thuthesis]
\def\thuthesis{{\sc ThuThesis}}

% use module 
\usemodule [bib]

% setup layout
\setuppapersize[A4][A4]
\setuplayout[width=fit,
	     height=middle,
             leftmargin=3cm,
	     rightmargin=3cm,
             backspace=4cm,
             topspace=2cm,
             headerdistance=.5cm,
             footerdistance=.5cm,
	     leftmargindistance=.5cm,
             rightmargindistance=.5cm,
             header=1cm,footer=1cm]
\setuppagenumbering[alternative=doublesided,
                    style=\tfx,
                    location={footer,middle}]

% setup font
\usetypescriptfile [zhfonts]
\usetypescript [thuthesis]
\setupbodyfont [thuthesis, 12pt]
\setupbodyfontenvironment[default][em=italic]

\def\thudefinefontsize%
  {\dodoubleargument\dothudefinefontsize}

% #1: font name 
% #2: default size
\def\dothudefinefontsize[#1][#2]{%
  \@EA\def\csname #1\endcsname{%
    \@EA\dosingleargument\csname do#1\endcsname}
   % ##1: line space
   \@EA\def\csname do#1\endcsname[##1]{%
     \switchtobodyfont[#2]
     \iffirstargument
       \setupinterlinespace[line=##1]
     \fi}}
	
\thudefinefontsize [chuhao]    [42bp]
\thudefinefontsize [xiaochu]   [36bp]
\thudefinefontsize [yihao]     [26bp]
\thudefinefontsize [xiaoyi]    [24bp]
\thudefinefontsize [erhao]     [22bp]
\thudefinefontsize [xiaoer]    [18bp]
\thudefinefontsize [sanhao]    [16bp]
\thudefinefontsize [xiaosan]   [15bp]
\thudefinefontsize [sihao]     [14bp]
\thudefinefontsize [banxiaosi] [13bp]
\thudefinefontsize [xiaosi]    [12bp]
\thudefinefontsize [dawu]      [11bp]
\thudefinefontsize [wuhao]     [10.5bp]
\thudefinefontsize [xiaowu]    [9bp]
\thudefinefontsize [liuhao]    [7.5bp]
\thudefinefontsize [xiaoliu]   [6.5bp]
\thudefinefontsize [qihao]     [5.5bp]
\thudefinefontsize [bahao]     [5bp]

% setup titles
\setupheads[indentnext=yes] % number format of section number
\setupheader[text][frame=off, bottomframe=on, style=\tfx]
\definepagebreak
    [mychapterpagebreak]
    [yes,header,right] % [pagebreak=yes,header,footer,openwhere=right]
\setuphead
   [title,chapter]
   [align=center,style=\bfb,page=mychapterpagebreak]
 %   [page=Mychapterpagebreak,header=empty,footer=empty]

\setuphead[section][style=\bfa]
\setuphead[subsubject][style=\bf]

\iffalse
\startsectionblockenvironment[frontpart]
  \setuppagenumbering[conversion=Romannumerals]
  \setuppagenumber[number=1]
\stopsectionblockenvironment

\startsectionblockenvironment[bodypart]
  \setuppagenumbering[conversion=number]
  \setuppagenumber[number=1]
  \setups{BodyHeaderFooter}
\stopsectionblockenvironment

\startsectionblockenvironment[backpart]
  % todo
\stopsectionblockenvironment

\startsectionblockenvironment[appendix]
  % todo:
\stopsectionblockenvironment

% hack to remove excess blank pages in the end. needed because front- and back-matter usage
% makes the system assume it is a book and therefore it adds pages to make the number even
\setupsectionblock[frontpart][page=no] %todo: number=yes|no?
\setupsectionblock[bodypart][page=no]
\setupsectionblock[appendix][page=no]
\setupsectionblock[backpart][page=no]
\fi

% setup chinese
\setuplabeltext [chapter={第\;,\;章}]
% \setuplabeltext [en] [section={第\;,\;节}]
\setuplabeltext [figure=图\;]
\setuplabeltext [table=表\;]
% \setupheadtext [en] [pubs={\bfc 参考文献}]
\setupheadtext [content={\bfc 目录}]

% setup figure directory
% 图片目录
\setupexternalfigures[directory={./figures}]

%% 目录 %%
\def\ChapterNumber#1{\doiftext{#1}{第\;#1\;章\quad}}
\setuplist
    [chapter]
    [alternative=c,
     before={\page[preference]\blank},
     after=\blank,
     style=\bf,
     width=fit,
     pagestyle=bold,
     pagenumber=yes,
     numbercommand=\ChapterNumber]

\def\PageNumber#1{\color[darkgray]{#1}.}
\setuplist
    [section]
    [alternative=c,
     style=normal,
     pagecommand=\PageNumber,
     pagestyle=\itx]


% 页眉页脚
\setupcombinedlist[content][level=3,alternative=c]
\startsetups BodyHeaderFooter
        \def\CurrentChapter{%
                第 \headnumber[chapter]\ 章%
                \hbox to 2em{}%
                \getmarking[chapter]}
        \def\CurrentSection{%
                \headnumber[section]%
                \hbox to 2em{}%
                \getmarking[section]}
        \setupheadertexts[text]
                [\CurrentChapter][]
                [][\CurrentSection]
        \setupfootertexts[text][][][][]
        \setupheader[style=\bfx]
        \setupfooter[style=\bfx]
\stopsetups

% 书签
\setupinteraction[state=start]
\setupinteractionscreen[option=bookmark]
\placebookmarks[chapter,section,subsection,subsubsection][chapter]

% 参考文献
%\setupbibtex[database=bibliography]
\setuppublications[alternative=num]

\setuppublicationlayout[booklet]{%
   \insertauthors{}{\unskip.}{}%
   \inserttitle{ \bgroup\it }{\/\egroup\unskip.}{}%
   \insertbiburl{ URL: }{\unskip.}{}%
   \insertnote{ }{\unskip.}{}}

\setuppublicationlayout[manual]{%
   \insertauthors{}{\unskip.}{}%
   \inserttitle{ \bgroup\it }{\/\egroup\unskip.}{}%
   \insertbiburl{ URL: }{\unskip.}{}%
   \insertnote{ }{\unskip.}{}}


%---- 其它
\setuptolerance 
  [verytolerant,stretch]
\setupinterlinespace
  [big]
\setupindenting
  [always,first,2em]

\setupfloats
  [indentnext=yes] 
\setupcaptions
  [style=\tfx, headstyle=\normal]

\definesymbol[1][{\color[darkgray]{\dag}}]
\setupitemize[each][packed,serried,inmargin][symbol=1,margin=2em]

\setupfootnotes[way=bypage]

\setupinmargin[left,right][style=\tfx]

\definedescription[definition]
        [location=top,hang=20,width=broad,indenting=always,style=\ss,headstyle=\bf]

\def\mycite#1{\high{\cite[#1]}}

\definesystemvariable{thu}    % general namespace
\definesystemvariable{thucn}  % for chinese namespace
\definesystemvariable{thuen}  % for english namespace

\startvariables all
	title: 		title
	degree:		degree
	department: 	department
	discipline:	discipline
	name:		name
	supervisor:	supervisor
	assupervisor:	assupervisor	% associated supervisor
	cosupervisor:	cosupervisor
	date:		date
\stopvariables

\setuplabeltext 
	[title=题目,
	 department=培养单位,
	 discipline=学科,
	 name=研究生,
	 supervisor=指导教师,
	 assupervisor=副指导教师,
	 cosupervisor=联合导师]

%D \type{\setupcover} collects meta-data to creat the cover. Since doctor dissertation 
%D has both Chinese and English covers, so we need collect two sets data, which is distinguished
%D with the first argument \type{cn | en}, and the second argument provides setup details. If only
%D one argument is supplied, we take \type{cn} as default. todo
\def\setupcover{%
  \dodoubleempty\dosetupcover}
\def\dosetupcover[#1][#2]{%
  \ifsecondargument
    \getparameters[\??thu#1][#2]%
  \else
    \getparameters[\??thucn][#1]%
  \fi}

\def\putentry#1{%
  \@EA\doifsomething\@EA{\csname @@thucn#1\endcsname}{%
    \labeltext{#1}：\getvalue{@@thucn#1}\par}}

\def\makecncover{%
	\startstandardmakeup
    % \setuplayout []
	\setupindenting [\v!no]
    \setupinterlinespace [\v!big]	
	\setupalign [\v!middle] % or: \raggedcenter, \setupalignment[]\stopalignment
	%\startalignment [\v!middle]
	\bgroup\ss\bfd\@@thucntitle\endgraf\egroup
    \blank[\v!small]
	（申请清华大学 \@@thucndegree 学位论文）

	\blank[2*\v!big]

	\putentry{department}
	\putentry{discipline}
	\putentry{name}
	\putentry{assupervisor}
	\putentry{cosupervisor}

	%\doifelsesomething{\@@thudate}{\currentdate}
	\@@thucndate	
	\stopstandardmakeup}

\def\makeencover{%
  \startstandardmakeup
  % \setuplayout []
  \setupindenting [\v!no]
  \setupinterlinespace [\v!big]
  \setupalign [\v!middle]  
	\bgroup\ss\bfd\@@thuentitle\endgraf\egroup
    \blank[3*\v!big]
    \startlines
     Dissertation Submitted to
     {\bf Tsinghua University}
     in partial fulfillment of the requirement
     for the degree of
     {\bf\ss \@@thuendegree}
     \blank[\v!big]
     by
    {\bf\ss \@@thuenname\par\@@thuendiscipline}
    \stoplines
	\starttabulate [|r|l|]
      \NC Dissertation Supervisor: \NC \@@thuensupervisor \NC \NR
      \NC Associate Supervisor: \NC \@@thuenassupervisor  \NC \NR
	\stoptabulate
 \blank[\v!big]

 {\bf\ss \@@thuendate}  
  \stopstandardmakeup
}

\startbuffer [authorization]
本人完全了解清华大学有关保留、使用学位论文的规定，即：

清华大学拥有在著作权法规定范围内学位论文的使用权，其中包括：（1）已获学位的研究生
必须按学校规定提交学位论文，学校可以采用影印、缩印或其他复制手段保存研究生上交的
学位论文；（2）为教学和科研目的，学校可以将公开的学位论文作为资料在图书馆、资料
室等场所供校内师生阅读，或在校园网上供校内师生浏览部分内容；（3）根据《中华人民
共和国学位条例暂行实施办法》，向国家图书馆报送可以公开的学位论文。

本人保证遵守上述规定。
\stopbuffer

\def\makeauthorization{%
  \startstandardmakeup %[doublesided=no]
  \title{关于学位论文使用授权的说明}

  \setupindenting [\v!yes,2em]
  \setupinterlinespace [\v!auto,\v!big]
  \getbuffer [authorization]

  {\bf（保密的论文在解密后应遵守此规定）}

  \startalignment [flushright]
  \def\@sigline##1{\hbox to 4em{##1}：\underbar{\hbox to 5em{}}}
  \@sigline{作者签名} \@sigline{导师签名}
  
  \@sigline{日期} \@sigline{日期}
  \stopalignment
  \stopstandardmakeup}

\startsetups [cover]  
  \makecncover
  \doifmode{doctor}{\makeencover}
  \makeauthorization
\stopsetups  

\def\startabstract{%
  \dosingleargument\dostartabstract}
  
\def\dostartabstract[#1]{%
  \dostartbuffer[abstract-#1][startabstract][stopabstract]}

\def\keywords{%
  \dodoubleempty\dokeywords}

\def\dokeywords[#1][#2]{%
  \edef\!!stringa{cn}
  \ifsecondargument
    \edef\!!stringa{#1}
  \fi
  \@EAEAEA\gdef\@EA\csname\@EA\??thu\!!stringa keywords\endcsname{#2}}
  
\startsetups [abstract]
  \title{摘要}
  \getbuffer[abstract-cn]\par
  
  \noindent{\bf 关键词：}\@@thucnkeywords
  
  \title{Abstract}
  \getbuffer[abstract-en]\par
  
  \noindent{\bf Keywords:} \doifdefined{@@thuenkeywords}{\@@thuenkeywords}
\stopsetups
  
\stopmodule
\protect \endinput

% test font availability
% \doiffontpresentelse{A} {
	% \definefontsynonym[sans][A]
% } {
	% \definefontsynonym[sans][B]
% }

% i guess that this also works

% \expanded{\definefontsynonym[sans][\doiffontpresentelse{A}{A}{B}]}

%\showframe
% http://wiki.contextgarden.net/Document_Titles
% http://source.contextgarden.net/doc/context/manuals/allkind/mcommon.tex
